<!DOCTYPE html>
<html lang="en">

<head>
  <%- include('../../partials/head.ejs'); %>
</head>

<body>
  <!-- navbar -->
  <%- include('../../partials/navbar.ejs'); %>

  <div v-cloak id="app">
    <!-- For rendev vuetify  -->
    <v-app>

      <!-- content -->
      <main class="main-content position-relative max-height-vh-100 h-100 border-radius-lg content">
        <div class="container-fluid py-2">
          <div class="row">
            <div class="col-12">
              <div class="card mb-4">
                <div class="card-header pb-3">
                  <div class="row">
                    <div class="col-3 col-md-3">
                      <h6>Ticket list</h6>
                      <div class="sub-title">รายการ Ticket</div>
                    </div>
                    <div class="col-9 col-md-9 content-add__ticket">
                      <a href="#" data-bs-toggle="modal" data-bs-target="#newTicketModal">
                        <i class="fas fa-plus-circle"></i> New Ticket
                        <div class="sub-title">สร้าง Ticket ใหม่</div>
                      </a>
                    </div>
                  </div>
                </div>
                <div class="card-body px-0 pt-0 pb-2">
                  <div class="table-responsive p-0">
                    <table class="table align-items-center mb-0">
                      <thead>
                        <tr>
                          <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">
                            Author
                          </th>
                          <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">
                            Function
                          </th>
                          <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">
                            Status
                          </th>
                          <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">
                            Employed
                          </th>
                          <th class="text-secondary opacity-7"></th>
                        </tr>
                      </thead>
                      <tbody>
                        <% for (var i = 0; i < 10; i++) { %>
                        <tr>
                          <td>
                            <div class="d-flex px-2 py-1">
                              <div>
                                <img src="/assets/images/team-2.jpg" class="avatar avatar-sm me-3" alt="user1" />
                              </div>
                              <div class="d-flex flex-column justify-content-center">
                                <h6 class="mb-0 text-sm">John Michael</h6>
                                <p class="text-xs text-secondary mb-0">
                                  john@creative-tim.com
                                </p>
                              </div>
                            </div>
                          </td>
                          <td>
                            <p class="text-xs font-weight-bold mb-0">Manager</p>
                            <p class="text-xs text-secondary mb-0">
                              Organization
                            </p>
                          </td>
                          <td class="align-middle text-center text-sm">
                            <span class="badge badge-sm bg-gradient-success">Online</span>
                          </td>
                          <td class="align-middle text-center">
                            <span class="text-secondary text-xs font-weight-bold">23/04/18</span>
                          </td>
                          <td class="align-middle">
                            <a href="javascript:;" class="text-secondary font-weight-bold text-xs" data-toggle="tooltip"
                              data-original-title="Edit user">
                              Edit
                            </a>
                          </td>
                        </tr>
                        <% } %>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </main>

      <!-- new ticket Modal -->
      <div class="modal fade" ref="newticketmodal" id="newTicketModal" tabindex="-1"
        aria-labelledby="newTicketModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="newTicketModalLabel">
                New Ticket
                <div class="sub-title">แจ้งปัญหา Ticket</div>
              </h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">


              <!-- overlay loading -->
              <div class="text-center">
                <v-overlay v-if="isLoading">
                  <%- include('../../partials/loading.ejs'); %>
                </v-overlay>
              </div>

              <!-- alert message -->
              <div>
                <v-alert v-model="alert" dense border="left" transition="scale-transition" type="warning">
                  <div class="text-h6">
                    Warning
                  </div>
                  <div>
                    {{ textAlert }}
                    <div class="sub-title-warning">{{ subTextAlert }}</div>
                  </div>
                </v-alert>
              </div>

              <div class="text-center">
                <v-snackbar v-model="snackbar" :timeout="timeout">
                  {{ text }}
                  <template v-slot:action="{ attrs }">
                    <v-btn color="blue" text v-bind="attrs" @click="snackbar = false">
                      Close
                    </v-btn>
                  </template>
                </v-snackbar>
              </div>

              <!-- modal content -->
              <div class="px-4">
                <form @submit.prevent="submitNewTicket">
                  <div class="form-group">
                    <label>Type</label>
                    <div class="sub-title">ประเภท</div>
                    <div class="mt-1 mb-3">
                      <select v-model="form.selectType" name="selectedType" class="form-control">
                        <option value="" disabled selected>
                          Select your option / เลือกประเภทปัญหา
                        </option>
                        <% for (var i = 0; i < category.length; i++) { %>
                        <option value="<%= category[i].catalog_id %>">
                          <%- category[i].catalog_nameTH %>
                        </option>
                        <% } %>
                      </select>
                    </div>
                  </div>

                  <div class="form-group">
                    <label>Detail</label>
                    <div class="sub-title">รายละเอียด</div>
                    <div class="mt-1 mb-3">
                      <textarea name="detail" v-model="form.inputDetail" class="form-control"
                        placeholder="รายละเอียด / detail" aria-label="รายละเอียด / detail"></textarea>
                    </div>
                  </div>

                  <div class="form-group">
                    <label>Attach file</label>
                    <div class="sub-title">แนบไฟล์</div>
                    <div class="mt-1 mb-3">
                      <input name="fileUpload" @change="uploadFile($event)" ref="file" type="file"
                        class="form-control" />
                    </div>
                  </div>

                  <div class="form-button">
                    <button ref="close" type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                      Close
                    </button>

                    <button type="submit" class="btn bg-gradient-primary">
                      Create Ticket
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>

    </v-app>
  </div>

  <!-- new ticket modal end -->
  <%- include('../../partials/footer.ejs'); %>

  <script type="text/javascript">
    const baseUrl = "<%- baseUrl %>";

    let app = new Vue({
      el: "#app",
      vuetify: new Vuetify(), // called vuetify
      data: {
        isLoading: false,
        alert: false,
        textAlert: '',
        subTextAlert: '',
        form: {
          selectType: "",
          inputDetail: "",
          fileUpload: "",
        },
        snackbar: false,
        text: '',
        timeout: 2000,
      },

      // listen กับ Data ที่เราต้องการ หากมีการเปลี่ยนแปลงค่า จะสามารถสั่งให้ทำ func บางอย่างได้
      watch: {

      },

      // computed จะคืนค่าล่าสุดเท่านั้น
      computed: {

      },

      // methods จะทำใหม่และคือค่านั้นกลับมา
      methods: {
        clearModal() {
          this.form.selectType = ''
          this.form.inputDetail = ''
          this.$refs.file.value = null;
        },

        uploadFile(event) {
          this.form.fileUpload = event.target.files[0];
        },

        submitNewTicket() {
          if (!this.form.selectType || !this.form.inputDetail) {
            this.alert = true;
            this.textAlert = "Please fill out the information completely";
            this.subTextAlert = "กรุณากรอกข้อมูลให้ครบถ้วน"
            setTimeout(() => {
              this.alert = false;
            }, 2000)
            return
          }

          // show loading
          this.isLoading = true;

          axios
            .post(`${baseUrl}user/add/new/ticket`, this.form, {
              headers: {
                "Content-Type": "multipart/form-data",
              },
            })
            .then(function (response) {
              let {
                status,
                message
              } = response.data

              if (status === 200) {
                this.snackbar = true;
                this.text = message;
              }

              if (status === 400) {
                this.snackbar = true
                this.text = message;
              }
            })
            .catch(function (error) {
              console.log(error);
            });
        },
      },

      beforeCreate() {

      },

      created() {

      },

      beforeMount() {

      },

      mounted() {
        // clear modal when dismiss
        $(this.$refs.newticketmodal).on("hidden.bs.modal", this.clearModal)
      },

      beforeUpdate() {

      },

      updated() {

      },

      beforedestroy() {

      },

      destroyed() {

      },
    });
  </script>
</body>

</html>